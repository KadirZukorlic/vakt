#!/usr/bin/env node

const https = require("https");

const CITY_ID = 117;
const URL = `https://api.vaktija.ba/vaktija/v1/${CITY_ID}`;

// Color codes
const colors = {
  reset: "\x1b[0m",
  bright: "\x1b[1m",
  dim: "\x1b[2m",
  red: "\x1b[31m",
  green: "\x1b[32m",
  yellow: "\x1b[33m",
  blue: "\x1b[34m",
  magenta: "\x1b[35m",
  cyan: "\x1b[36m",
};

function fetchJSON(url) {
  return new Promise((resolve, reject) => {
    https
      .get(url, (res) => {
        let data = "";
        res.on("data", (chunk) => (data += chunk));
        res.on("end", () => resolve(JSON.parse(data)));
      })
      .on("error", reject);
  });
}

(async () => {
  const data = await fetchJSON(URL);
  const { vakat } = data;

  const now = new Date();
  const nowMinutes = now.getHours() * 60 + now.getMinutes();

  const prayersInMinutes = vakat.map((time) => {
    const [h, m] = time.split(":").map(Number);
    return h * 60 + m;
  });

  let nextPrayerMinutes = null;
  let nextPrayerIndex = null;

  for (let i = 0; i < prayersInMinutes.length; i++) {
    if (nowMinutes < prayersInMinutes[i]) {
      nextPrayerIndex = i;
      nextPrayerMinutes = prayersInMinutes[i];
      break;
    }
  }

  const prayerInfo = getPrayerInfo(nextPrayerIndex);
  const minutesRemaining = nextPrayerMinutes - nowMinutes;
  const timeString = formatTime(minutesRemaining);

  console.log(
    `${prayerInfo.icon} ${prayerInfo.color}${prayerInfo.name} je za ${colors.bright}${colors.yellow}${timeString}${colors.reset}`
  );
})();

function formatTime(minutes) {
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;

  let result = "";
  if (hours > 0) {
    if (hours === 1) {
      result += "1 sat";
    } else if (hours === 2 || hours === 3 || hours === 4) {
      result += `${hours} sata`;
    } else {
      result += `${hours} sati`;
    }
  }

  if (mins > 0) {
    if (hours > 0) {
      result += " i ";
    }
    result += `${mins} minuta`;
  }

  return result;
}

function getPrayerInfo(index) {
  const prayers = [
    { name: "Sabah", icon: "ğŸŒ…", color: colors.blue },
    { name: "Izlazak sunca", icon: "â˜€ï¸", color: colors.yellow },
    { name: "Ikindija", icon: "ğŸŒ¤ï¸", color: colors.magenta },
    { name: "AkÅ¡am", icon: "ğŸŒ†", color: colors.red },
    { name: "Jacija", icon: "ğŸŒ™", color: colors.cyan },
  ];

  return prayers[index] || prayers[0];
}
